(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,137,e=>{"use strict";var s=e.i(43476),a=e.i(71645),t=e.i(17927);function r(){let[e,r]=(0,a.useState)(null),[i,l]=(0,a.useState)(!1),[n,d]=(0,a.useState)(null),[o,c]=(0,a.useState)(!1),[m,u]=(0,a.useState)([]),[h,x]=(0,a.useState)(""),[p,g]=(0,a.useState)(""),[b,j]=(0,a.useState)(""),[f,N]=(0,a.useState)(null),[y,v]=(0,a.useState)("food-test"),[w,S]=(0,a.useState)("gemini-3-pro-preview"),[_,C]=(0,a.useState)("v1"),[k,E]=(0,a.useState)(null),[A,T]=(0,a.useState)([]);async function B(){let{data:e}=await t.supabase.auth.getSession();return e.session?.access_token||""}async function O(){d(null),c(!0);try{let e=await B();if(!e)throw Error("请先登录");let s=await fetch("/api/admin/eval-suites",{headers:{Authorization:`Bearer ${e}`}}),a=await s.json();if(!s.ok)throw Error(a?.message||"无权限或请求失败");l(!0),u(a.items||[]),!h&&(a.items||[]).length&&x(a.items[0].id)}catch(e){l(!1),u([]),d(e?.message||"请求失败")}finally{c(!1)}}async function $(){d(null),c(!0);try{let e=await B();if(!e)throw Error("请先登录");let s=await fetch("/api/admin/eval-suites",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({name:p.trim(),description:b.trim()})}),a=await s.json();if(!s.ok)throw Error(a?.message||"创建失败");g(""),j(""),await O()}catch(e){d(e?.message||"创建失败")}finally{c(!1)}}async function z(){d(null),c(!0);try{if(!h)throw Error("请先选择数据集");if(!f||0===f.length)throw Error("请选择图片");let e=await B();if(!e)throw Error("请先登录");let s=new FormData;s.set("suite_id",h),s.set("source",y),Array.from(f).forEach(e=>s.append("files",e));let a=await fetch("/api/admin/eval-cases/upload",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:s}),t=await a.json();if(!a.ok)throw Error(t?.message||"上传失败");alert(`上传成功：${(t.items||[]).length} 张`)}catch(e){d(e?.message||"上传失败")}finally{c(!1)}}async function P(){d(null),E(null),T([]),c(!0);try{if(!h)throw Error("请先选择数据集");let e=await B();if(!e)throw Error("请先登录");let s=await fetch("/api/admin/eval-runs/run",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({suite_id:h,model_name:w,prompt_version:_})}),a=await s.json();if(!s.ok)throw Error(a?.message||"执行失败");E(a);let t=await fetch(`/api/admin/eval-runs/results?run_id=${encodeURIComponent(a.run_id)}`,{headers:{Authorization:`Bearer ${e}`}}),r=await t.json();t.ok&&T(r.items||[])}catch(e){d(e?.message||"执行失败")}finally{c(!1)}}return((0,a.useMemo)(async()=>{let{data:e}=await t.supabase.auth.getSession();return e.session?.access_token||""},[e?.id]),(0,a.useEffect)(()=>{t.supabase.auth.getSession().then(({data:e})=>r(e.session?.user??null));let{data:e}=t.supabase.auth.onAuthStateChange((e,s)=>r(s?.user??null));return()=>e.subscription.unsubscribe()},[]),(0,a.useEffect)(()=>{e&&O()},[e?.id]),e)?!i&&n?(0,s.jsxs)("div",{className:"min-h-screen p-6 max-w-3xl mx-auto",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"评测后台 · 执行台"}),(0,s.jsx)("div",{className:"mt-4 p-3 border rounded bg-yellow-50 text-sm text-yellow-800",children:n})]}):(0,s.jsxs)("div",{className:"min-h-screen p-6 max-w-3xl mx-auto",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"评测后台 · 执行台"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"创建数据集 → 批量上传测试图 → 一键跑实验（落库 metrics）。"}),n&&(0,s.jsx)("div",{className:"mt-4 p-3 border rounded bg-red-50 text-sm text-red-700",children:n}),(0,s.jsxs)("div",{className:"mt-6 p-4 border rounded",children:[(0,s.jsx)("div",{className:"font-medium mb-3",children:"数据集（Suite）"}),(0,s.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,s.jsxs)("select",{className:"border rounded px-3 py-2 w-full",value:h,onChange:e=>x(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"请选择"}),m.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,s.jsx)("button",{className:"border rounded px-3 py-2 text-sm",onClick:O,disabled:o,children:"刷新"})]}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-1 gap-2",children:[(0,s.jsx)("input",{className:"border rounded px-3 py-2",value:p,onChange:e=>g(e.target.value),placeholder:"新数据集名称"}),(0,s.jsx)("input",{className:"border rounded px-3 py-2",value:b,onChange:e=>j(e.target.value),placeholder:"描述（可选）"}),(0,s.jsx)("button",{className:"border rounded px-3 py-2 bg-black text-white disabled:opacity-50",onClick:$,disabled:o||!p.trim(),children:"创建数据集"})]})]}),(0,s.jsxs)("div",{className:"mt-6 p-4 border rounded",children:[(0,s.jsx)("div",{className:"font-medium mb-3",children:"批量上传测试图片（Case）"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[(0,s.jsx)("input",{className:"border rounded px-3 py-2",value:y,onChange:e=>v(e.target.value),placeholder:"source（例如 food-test）"}),(0,s.jsx)("input",{className:"border rounded px-3 py-2",type:"file",accept:"image/*",multiple:!0,onChange:e=>N(e.target.files)}),(0,s.jsx)("button",{className:"border rounded px-3 py-2 bg-black text-white disabled:opacity-50",onClick:z,disabled:o||!h,children:"上传"}),(0,s.jsxs)("div",{className:"text-xs text-gray-600",children:["会把文件名中的 ",(0,s.jsx)("code",{children:"xxxg"})," 自动解析为 ",(0,s.jsx)("code",{children:"ground_truth.total_weight_grams"}),"（如有）。"]})]})]}),(0,s.jsxs)("div",{className:"mt-6 p-4 border rounded",children:[(0,s.jsx)("div",{className:"font-medium mb-3",children:"跑实验（Run）"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[(0,s.jsx)("input",{className:"border rounded px-3 py-2",value:w,onChange:e=>S(e.target.value),placeholder:"model_name"}),(0,s.jsx)("input",{className:"border rounded px-3 py-2",value:_,onChange:e=>C(e.target.value),placeholder:"prompt_version"}),(0,s.jsx)("button",{className:"border rounded px-3 py-2 bg-green-600 text-white disabled:opacity-50",onClick:P,disabled:o||!h,children:"一键执行（顺序跑，耗时取决于图片数）"})]}),k&&(0,s.jsxs)("div",{className:"mt-3 text-sm border rounded p-3 bg-gray-50",children:["run_id: ",(0,s.jsx)("code",{children:k.run_id}),"，成功 ",k.ok," / 失败 ",k.failed," / 总计 ",k.total]}),A.length>0&&(0,s.jsx)("div",{className:"mt-3 border rounded overflow-hidden",children:(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"text-left p-2",children:"case_id"}),(0,s.jsx)("th",{className:"text-left p-2",children:"mape"}),(0,s.jsx)("th",{className:"text-left p-2",children:"abs_error(g)"}),(0,s.jsx)("th",{className:"text-left p-2",children:"error"})]})}),(0,s.jsx)("tbody",{children:A.map(e=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2 font-mono",children:e.case_id}),(0,s.jsx)("td",{className:"p-2",children:e.metrics?.mape!=null?Number(e.metrics.mape).toFixed(3):"-"}),(0,s.jsx)("td",{className:"p-2",children:e.metrics?.abs_error_grams!=null?Math.round(Number(e.metrics.abs_error_grams)):"-"}),(0,s.jsx)("td",{className:"p-2 text-red-700",children:e.error_message||""})]},e.id))})]})})]})]}):(0,s.jsxs)("div",{className:"min-h-screen p-6 max-w-3xl mx-auto",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"评测后台 · 执行台"}),(0,s.jsx)("div",{className:"mt-4 p-3 border rounded bg-gray-50 text-sm",children:"请先在首页登录后再访问。"})]})}e.s(["default",()=>r])}]);