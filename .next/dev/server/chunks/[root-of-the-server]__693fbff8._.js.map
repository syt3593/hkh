{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///D:/files/hkh/app/api/analyze/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { GoogleGenAI, Type } from '@google/genai'\r\nimport type { FoodItem } from '../../../types'\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const apiKey = process.env.GEMINI_API_KEY || process.env.API_KEY\r\n    if (!apiKey) {\r\n      return NextResponse.json({ message: '缺少 GEMINI_API_KEY（或 API_KEY）环境变量' }, { status: 500 })\r\n    }\r\n\r\n    const body = await req.json()\r\n    const base64Image = String(body?.base64Image || '')\r\n    const additionalContext = String(body?.additionalContext || '')\r\n    const modelName = String(body?.modelName || 'gemini-3-pro-preview')\r\n\r\n    if (!base64Image) {\r\n      return NextResponse.json({ message: 'base64Image 不能为空' }, { status: 400 })\r\n    }\r\n\r\n    const ai = new GoogleGenAI({ apiKey })\r\n\r\n    const prompt = `\r\n请作为专业的营养师分析这张食物图片。\r\n1. 识别图中所有不同的食物单品。\r\n2. 估算每种食物的重量（克）和详细营养成分。\r\n3. description: 提供这顿饭的简短中文描述。\r\n4. insight: 提供一个“洞察”建议：基于该餐营养成分的一句话健康建议（例如：“蛋白质含量高，适合肌肉恢复”或“建议加点绿叶菜以平衡碳水”）。\r\n\r\n${additionalContext ? `用户补充背景信息: \"${additionalContext}\"。请根据此信息调整对隐形成分或烹饪方式的判断。` : ''}\r\n\r\n重要：请务必使用**简体中文**返回所有文本内容（包括 name, description, insight）。\r\n请严格按照指定的 JSON 格式返回数据。\r\n`.trim()\r\n\r\n    const imagePart = {\r\n      inlineData: {\r\n        mimeType: 'image/jpeg',\r\n        data: base64Image.includes(',') ? base64Image.split(',')[1] : base64Image,\r\n      },\r\n    }\r\n    const textPart = { text: prompt }\r\n\r\n    const response = await ai.models.generateContent({\r\n      model: modelName,\r\n      contents: { parts: [imagePart, textPart] },\r\n      config: {\r\n        responseMimeType: 'application/json',\r\n        responseSchema: {\r\n          type: Type.OBJECT,\r\n          properties: {\r\n            items: {\r\n              type: Type.ARRAY,\r\n              items: {\r\n                type: Type.OBJECT,\r\n                properties: {\r\n                  name: { type: Type.STRING, description: '食物名称，使用简体中文' },\r\n                  estimatedWeightGrams: { type: Type.NUMBER },\r\n                  nutrients: {\r\n                    type: Type.OBJECT,\r\n                    properties: {\r\n                      calories: { type: Type.NUMBER },\r\n                      protein: { type: Type.NUMBER },\r\n                      carbs: { type: Type.NUMBER },\r\n                      fat: { type: Type.NUMBER },\r\n                      fiber: { type: Type.NUMBER },\r\n                      sugar: { type: Type.NUMBER },\r\n                    },\r\n                    required: ['calories', 'protein', 'carbs', 'fat', 'fiber', 'sugar'],\r\n                  },\r\n                },\r\n                required: ['name', 'estimatedWeightGrams', 'nutrients'],\r\n              },\r\n            },\r\n            description: { type: Type.STRING, description: '餐食描述，使用简体中文' },\r\n            insight: { type: Type.STRING, description: '健康建议，使用简体中文' },\r\n          },\r\n          required: ['items', 'description', 'insight'],\r\n        },\r\n      },\r\n    })\r\n\r\n    let jsonStr = response.text\r\n    if (!jsonStr) throw new Error('AI 返回了空响应，请检查图片或稍后重试。')\r\n    jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim()\r\n\r\n    let parsed: any\r\n    try {\r\n      parsed = JSON.parse(jsonStr)\r\n    } catch {\r\n      throw new Error('AI 数据解析失败，请重试。')\r\n    }\r\n\r\n    const validItems = Array.isArray(parsed.items)\r\n      ? parsed.items.map((item: any) => {\r\n          const nutrients = {\r\n            calories: Number(item?.nutrients?.calories) || 0,\r\n            protein: Number(item?.nutrients?.protein) || 0,\r\n            carbs: Number(item?.nutrients?.carbs) || 0,\r\n            fat: Number(item?.nutrients?.fat) || 0,\r\n            fiber: Number(item?.nutrients?.fiber) || 0,\r\n            sugar: Number(item?.nutrients?.sugar) || 0,\r\n          }\r\n          return {\r\n            name: String(item?.name || '未知食物'),\r\n            estimatedWeightGrams: Number(item?.estimatedWeightGrams) || 0,\r\n            originalWeightGrams: Number(item?.estimatedWeightGrams) || 0,\r\n            nutrients,\r\n          } satisfies Omit<FoodItem, 'id' | 'consumedPercentage'>\r\n        })\r\n      : []\r\n\r\n    return NextResponse.json({\r\n      description: String(parsed.description || '无法获取描述'),\r\n      insight: String(parsed.insight || '保持健康饮食！'),\r\n      items: validItems,\r\n    })\r\n  } catch (error: any) {\r\n    console.error('[api/analyze] error:', error)\r\n    return NextResponse.json({ message: error?.message || '连接 AI 服务失败' }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}